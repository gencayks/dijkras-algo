/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var w=Object.create;var p=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var _=(n,e)=>{for(var t in e)p(n,t,{get:e[t],enumerable:!0})},b=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of R(e))!A.call(n,i)&&i!==t&&p(n,i,{get:()=>e[i],enumerable:!(s=E(e,i))||s.enumerable});return n};var T=(n,e,t)=>(t=n!=null?w(F(n)):{},b(e||!n||!n.__esModule?p(t,"default",{value:n,enumerable:!0}):t,n)),B=n=>b(p({},"__esModule",{value:!0}),n);var V={};_(V,{default:()=>S});module.exports=B(V);var y=T(require("http")),x=require("events");var D=(n,e)=>{switch(console.log(n.type,n.data),n.type){case"FolderCompletion":if(e.folderId&&n.data.folder!==e.folderId)break;let t=n.data.completion,s=n.data.globalItems,i=n.data.needItems;e.fileCompletion=t,e.globalItems=s,e.needItems=i,t!==100?e.setStatusIcon("\u{1F7E1}"):e.setStatusIcon("\u{1F7E2}");break;case"StateChanged":if(e.folderId&&n.data.folder!==e.folderId)break;let a=n.data.to;e.status=a,a==="scanning"?e.setStatusIcon("\u{1F7E1}"):e.setStatusIcon("\u{1F7E2}");break;case"DeviceDisconnected":e.setStatusIcon("\u{1F534}"),e.status="Disconnected";break}};var I=class extends x.EventEmitter{constructor(){super(...arguments);this.token=null;this.connectedDevicesCount=0;this.availableDevices=0;this.isTokenSet=!1}listenForEvents(t,s){this.currentSettings=t,this.token=t.syncthingToken,this.timeout=t.pollingTimeout,this.folderId=t.folderId||null,this.status="idle",this.setStatusIcon=s,this.isTokenSet=!!t.syncthingToken,this.isTokenSet?(this.poll(),this.checkConnections()):(this.status="API key not set",this.emit("status-update",{status:this.status,fileCompletion:NaN,globalItems:NaN,needItems:NaN,connectedDevicesCount:NaN,availableDevices:NaN}))}updateSettings(t){this.stopPolling(),this.listenForEvents(t,this.setStatusIcon)}stopPolling(){this.pollingTimeoutId&&(clearTimeout(this.pollingTimeoutId),this.pollingTimeoutId=void 0),this.lastEventId=void 0,this.status="stopped",this.emit("disconnected")}poll(){var a;let t=(a=this.lastEventId)!=null?a:0;if(!this.token){console.error("Syncthing API token is not set. Cannot poll for events."),this.status="API key not set",this.emit("status-update",{status:this.status,fileCompletion:NaN,globalItems:NaN,needItems:NaN,connectedDevicesCount:NaN,availableDevices:NaN});return}let s={hostname:"localhost",port:8384,path:`/rest/events?since=${t}&timeout=${this.timeout}`,method:"GET",headers:{Authorization:`Bearer ${this.token}`}},i=y.request(s,o=>{let l="";o.on("data",c=>{l+=c}),o.on("end",()=>{var r;let c=/CSRF Error/i;if(o.statusCode===401||c.test(l)){console.error("Syncthing API key is invalid (401 Unauthorized or CSRF Error)."),this.status="Invalid API key",this.emit("status-update",{status:this.status,fileCompletion:NaN,globalItems:NaN,needItems:NaN,connectedDevicesCount:NaN,availableDevices:NaN}),this.pollingTimeoutId=setTimeout(()=>this.poll(),5e3);return}try{let d=JSON.parse(l),m=d.length;if(Array.isArray(d))for(let g of d)this.lastEventId=Math.max((r=this.lastEventId)!=null?r:0,g.id),D(g,this)}catch(d){console.error("Failed to parse Syncthing events or unexpected response:",d)}finally{this.checkConnections(),this.emit("status-update",{status:this.status,fileCompletion:this.fileCompletion,globalItems:this.globalItems,needItems:this.needItems,connectedDevicesCount:this.connectedDevicesCount}),this.pollingTimeoutId=setTimeout(()=>this.poll(),this.timeout*1e3)}})});i.on("error",o=>{console.error("Syncthing connection error:",o),this.pollingTimeoutId=setTimeout(()=>this.poll(),5e3)}),i.end()}checkConnections(){if(!this.token){console.error("Syncthing API token is not set. Cannot check connections."),this.status="API key not set",this.emit("status-update",{status:this.status,fileCompletion:NaN,globalItems:NaN,needItems:NaN,connectedDevicesCount:NaN,availableDevices:NaN});return}let t={hostname:"localhost",port:8384,path:"/rest/system/connections",method:"GET",headers:{Authorization:`Bearer ${this.token}`}},s=y.request(t,i=>{let a="";i.on("data",o=>{a+=o}),i.on("end",()=>{let o=/CSRF Error/i;if(i.statusCode===401||o.test(a)){console.error("Syncthing API key is invalid (401 Unauthorized or CSRF Error)."),this.status="Invalid API key",this.emit("status-update",{status:this.status,fileCompletion:NaN,globalItems:NaN,needItems:NaN,connectedDevicesCount:NaN,availableDevices:NaN});return}try{let l=JSON.parse(a),c=Object.values(l.connections);this.availableDevices=c.length,this.connectedDevicesCount=c.filter(r=>r.connected).length,this.connectedDevicesCount===0&&this.setStatusIcon("\u{1F7E1}")}catch(l){console.error("Failed to parse Syncthing connections or unexpected response:",l)}finally{this.emit("status-update",{status:this.status,fileCompletion:this.fileCompletion,globalItems:this.globalItems,needItems:this.needItems,connectedDevicesCount:this.connectedDevicesCount,availableDevices:this.availableDevices})}})});s.on("error",i=>{console.error("Syncthing connections API error:",i)}),s.end()}};var v=require("obsidian");var h=require("obsidian"),f=class extends h.PluginSettingTab{constructor(e,t,s){super(e,t),this.plugin=t,this.monitor=s}display(){let{containerEl:e}=this;e.empty(),new h.Setting(e).setName("Polling timeout").setDesc("How often the system checks for new events.").addText(t=>t.setPlaceholder("1").setValue(String(this.plugin.settings.pollingTimeout)).onChange(async s=>{let i=Number(s);Number.isNaN(i)?console.log("Couldn't parse number"):(this.plugin.settings.pollingTimeout=i,await this.plugin.saveSettings(),this.monitor.updateSettings(this.plugin.settings))})),new h.Setting(e).setName("Syncthing token").setDesc("API token to use Syncthing API. You can find this in Syncthing UI: Actions (top right) -> Settings -> GUI -> API Key.").addText(t=>t.setPlaceholder("").setValue(this.plugin.settings.syncthingToken).onChange(async s=>{this.plugin.settings.syncthingToken=s,await this.plugin.saveSettings(),this.monitor.updateSettings(this.plugin.settings)})),new h.Setting(e).setName("Folder ID").setDesc("Syncthing folder ID, without setting this the plugin will pickup changes from any of your synced folders").addText(t=>t.setPlaceholder("").setValue(this.plugin.settings.folderId).onChange(async s=>{this.plugin.settings.folderId=s,await this.plugin.saveSettings(),this.monitor.updateSettings(this.plugin.settings)}))}};var k=(n,e)=>{let t=document.createElement("div");t.classList.add("floating-widget");let s=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),l=document.createElement("div");t.appendChild(s),t.appendChild(i),t.appendChild(a),t.appendChild(o),t.appendChild(l),document.body.appendChild(t);let c=()=>{var d;if(e.status==="Invalid API key"||!e.isTokenSet){i.textContent="",a.textContent="",o.textContent="",l.textContent="",e.isTokenSet?e.status==="Invalid API key"&&(s.textContent="Invalid Syncthing API key. Please check your settings."):s.textContent="Please insert your Syncthing API key in the plugin settings.";return}let r=e.fileCompletion!==void 0?parseFloat(e.fileCompletion.toFixed(2)):void 0;i.textContent=`Sync status: ${r!=null?r:"N/A"}%`,o.textContent=`Files not synced: ${(d=e.needItems)!=null?d:"N/A"}`,l.textContent=`Connected devices: ${e.connectedDevicesCount}/${e.availableDevices}`};return c(),e.on("status-update",c),n.addEventListener("mouseenter",()=>{t.style.display="block",t.style.visibility="hidden",t.style.left="0",t.style.top="0",requestAnimationFrame(()=>{let r=n.getBoundingClientRect(),d=t.getBoundingClientRect(),m=r.left+window.scrollX-d.width+r.width,g=r.top+window.scrollY-d.height-8;m<0&&(m=8),t.style.left=`${m}px`,t.style.top=`${g}px`,t.style.visibility="visible"})}),n.addEventListener("mouseleave",()=>{t.style.display="none"}),t};var P=require("obsidian"),u="syncthing-status",C=class extends P.ItemView{constructor(t,s){super(t);this.handleStatusUpdate=t=>{this.status=t.status,this.fileCompletion=t.fileCompletion,this.globalItems=t.globalItems,this.needItems=t.needItems,this.connectedDevicesCount=t.connectedDevicesCount,this.availableDevices=t.availableDevices,this.render()};this.monitor=s,this.status=this.monitor.status,this.fileCompletion=this.monitor.fileCompletion||NaN,this.globalItems=this.monitor.globalItems||NaN,this.needItems=this.monitor.needItems||NaN,this.connectedDevicesCount=this.monitor.connectedDevicesCount||NaN,this.availableDevices=this.monitor.availableDevices||NaN,this.icon="syncthing-icon"}getViewType(){return u}getDisplayText(){return"Syncthing Status"}async onOpen(){this.render(),this.monitor.on("status-update",this.handleStatusUpdate)}async onClose(){this.monitor.off("status-update",this.handleStatusUpdate)}render(){let t=this.containerEl.children[1];if(t.empty(),t.createEl("h4",{text:"Syncthing Status"}),!this.monitor.isTokenSet){t.createEl("p",{text:"Please insert your Syncthing API key in the plugin settings to monitor status."});return}if(this.status==="Invalid API key"){t.createEl("p",{text:"Invalid Syncthing API key. Please check your settings."});return}let s=t.createEl("div",{cls:"syncthing-status-item syncthing-no-border"});s.createEl("span",{cls:"syncthing-status-label",text:"Sync status:"}),s.createEl("span",{cls:"syncthing-status-value",text:`${isNaN(this.fileCompletion)?"0.00":parseFloat(this.fileCompletion.toFixed(2))}%`});let a=t.createEl("div",{cls:"syncthing-progress-bar-container"}).createEl("div",{cls:"syncthing-progress-bar"});a.style.width=`${isNaN(this.fileCompletion)?0:this.fileCompletion}%`;let o=t.createEl("div",{cls:"syncthing-status-item"});o.createEl("span",{cls:"syncthing-status-label",text:"Files not synced"}).createEl("span",{text:" (includes .obsidian files)",cls:"syncthing-small-text"}),o.createEl("span",{cls:"syncthing-status-value",text:`${isNaN(this.needItems)?0:this.needItems}`});let c=t.createEl("div",{cls:"syncthing-status-item"});c.createEl("span",{cls:"syncthing-status-label",text:"Connected devices:"}),c.createEl("span",{cls:"syncthing-status-value",text:`${isNaN(this.connectedDevicesCount)?0:this.connectedDevicesCount}/${isNaN(this.availableDevices)?0:this.availableDevices}`})}async setState(t,s){return t.status&&(this.status=t.status),t.fileCompletion&&(this.fileCompletion=t.fileCompletion),t.globalItems&&(this.globalItems=t.globalItems),t.needItems&&(this.needItems=t.needItems),t.availableDevices&&(this.availableDevices=t.availableDevices),super.setState(t,s)}};var L=`
<svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" id="Layer_1" x="0" y="0" version="1.1" viewBox="0 0 118 118"><style>.st1{fill:none;stroke:#fff;stroke-width:6;stroke-miterlimit:10}.st2{fill:#fff}</style><linearGradient id="SVGID_1_" x1="59.05" x2="59.05" y1="2.95" y2="120.35" gradientTransform="matrix(1 0 0 -1 0 120.7)" gradientUnits="userSpaceOnUse"><stop offset="0" style="stop-color:#0882c8"/><stop offset="1" style="stop-color:#26b6db"/></linearGradient><circle cx="59" cy="59" r="58.7" style="fill:url(#SVGID_1_)"/><circle cx="59" cy="58.8" r="43.7" class="st1"/><path d="M95 48.1c4.7 1.6 9.8-.9 11.4-5.6s-.9-9.8-5.6-11.4-9.8.9-11.4 5.7.9 9.7 5.6 11.3" class="st2"/><path d="m97.9 39.8-30.1 25" class="st1"/><path d="M77.9 91.3c-.4 4.9 3.2 9.3 8.2 9.8 5 .4 9.3-3.2 9.8-8.2.4-4.9-3.2-9.3-8.2-9.8-4.9-.3-9.4 3.2-9.8 8.2" class="st2"/><path d="m86.8 92.2-19-27.4" class="st1"/><path d="M60.3 69.7c2.7 4.2 8.3 5.4 12.4 2.7 4.2-2.7 5.4-8.3 2.7-12.4-2.7-4.2-8.3-5.4-12.4-2.7-4.2 2.5-5.4 8.1-2.7 12.4m-38.8-7.9c-4.3-2.5-9.8-1.1-12.3 3.1-2.5 4.3-1.1 9.8 3.1 12.3 4.3 2.5 9.8 1.1 12.3-3.1 2.5-4.3 1.1-9.8-3.1-12.3" class="st2"/><path d="m16.9 69.4 50.9-4.6" class="st1"/></svg>
`;var M={pollingTimeout:1,syncthingToken:"",folderId:""},S=class extends v.Plugin{constructor(){super(...arguments);this.setStatusIcon=t=>{this.statusBarItem.setText(t)}}async onload(){let t=new I;await this.loadSettings(),this.addSettingTab(new f(this.app,this,t)),this.registerView(u,s=>new C(s,t)),(0,v.addIcon)("syncthing-icon",L),this.addRibbonIcon("syncthing-icon","Activate view",()=>{this.activateView()}),this.statusBarItem=this.addStatusBarItem(),this.statusBarItem.setText("Loading..."),t.on("connected",()=>{this.statusBarItem.setText("\u{1F7E2}"),this.statusBarItem.setAttribute("title","Connected to Syncthing")}),t.on("disconnected",()=>{this.statusBarItem.setText("\u{1F534}"),this.statusBarItem.setAttribute("title","Disconnected from Syncthing")}),t.listenForEvents(this.settings,this.setStatusIcon),this.addCommand({id:"display-syncthing-view",name:"Display Syncthing information",callback:()=>{this.activateView()}}),k(this.statusBarItem,t)}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async activateView(){let{workspace:t}=this.app,s=null,i=t.getLeavesOfType(u);i.length>0?s=i[0]:(s=t.getRightLeaf(!1),await(s==null?void 0:s.setViewState({type:u,active:!0}))),s&&t.revealLeaf(s)}async saveSettings(){await this.saveData(this.settings)}};

/* nosourcemap */